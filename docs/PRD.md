# PRD（产品需求文档） — cticloud-agentsdk-demo
角色：PM Agent「周衡」

## 背景与目标
- 背景：在现有坐席工作台中集成 CTICloud AgentSDK 的前端工具条，以验证 SDK 在典型坐席工作流中的可用性、事件完整性与软电话能力。
- 产品定位：演示型前端工具条（Demo），用于研发/验收环境的功能连通性验证与体验，不涉及后端系统改造与生产发布。
- 目标：完成最小闭环流程——登录 → 事件订阅 → 预览外呼 → 软电话接听/挂断 → 登出，并对关键异常分支做显式处理与可视化。

## 范围与不包含项
- 范围（包含）：
  - 集成并调用 AgentSDK 的前端工具条能力：登录/登出、事件订阅、预览外呼、软电话 sipLink/sipUnlink。
  - 提供状态指示与事件日志面板，展示关键事件与载荷片段。
  - 进行基础连通性与拨测验证，覆盖错误处理分支。
- 不包含：
  - 任何后端服务改造、网关/号码/路由配置变更、SIP 服务器参数调整。
  - 生产环境上线相关工作（发布流程、安全评审、监控接入、容量评估）。
  - 账号体系、权限体系的后端改造与用户管理页面。
  - 呼叫录音、报表统计、弹屏联动、CRM/工单集成等扩展功能。

## 用户故事
- 坐席登录
  - 作为坐席，我可以输入必要的凭据并登录工作台，看到当前登录状态与我的坐席信息（例如坐席号、业务线）。
- 预览外呼
  - 作为坐席，我可以发起预览外呼，工具条显示外呼进度与事件（拨号、振铃、接通/失败），并在完成后展示结果事件与返回码。
- 软电话（SIP）
  - 作为坐席，我可以通过软电话模式进行 sipLink 连接，接听或挂断；必要时执行 sipUnlink 断开，工具条显示当前软电话状态。
- 断线与重连提示
  - 当 SDK 或网络断线时，我可以收到可视化提示，并在恢复后看到重连成功的状态与关键事件。

## 功能需求
- 登录/登出
  - 提供登录 UI：输入必要的配置/凭据（例如环境地址、业务线标识、坐席标识、鉴权令牌）。
  - 调用 AgentSDK 登录方法，校验返回码（code=0 为成功），展示成功/失败提示。
  - 登出将清理事件订阅与会话状态，UI 恢复为未登录态。
- 事件订阅与展示
  - 登录成功后自动或手动开启事件订阅（可通过开关控制）。
  - 事件日志面板实时追加关键事件（事件名、时间、载荷片段），支持简单过滤（例如仅显示错误事件）。
  - 必须覆盖呼叫相关关键事件，便于拨测验证与问题定位。
- 预览外呼
  - 提供外呼输入：被叫号码、可选外显号码/业务参数（如 SDK 要求），发起 previewObCall。
  - UI 显示外呼进度；完成后展示 result 事件与返回码/原因。
  - 错误分支：号码校验失败、网络异常、SDK Promise reject、返回码非 0 等。
- 软电话（SIP）
  - 提供 sipLink / sipUnlink 控件与状态指示（已连接/未连接）。
  - 在连接成功后可接听/挂断模拟流程（依据 SDK 能力，至少展示事件与状态变化）。
  - 错误分支：连接失败、断开失败、会话异常、网络抖动导致的重连。
- 可视化与交互
  - 顶部或侧边工具条呈现登录状态、连接状态（SDK、SIP）、事件订阅开关、操作按钮（外呼、Link/Unlink）、简要统计（当天事件数）。
  - 使用非侵入式提示（Toast/Badge）反馈成功与错误；重大错误提供可重试入口。

## 非功能需求
- 安全与协议（HTTPS）
  - Demo 运行环境通过 HTTPS 提供前端页面；与 AgentSDK 后端交互需符合 SDK 要求（优先 HTTPS）。
  - 不在 Demo 中存储敏感凭据的持久化；本地仅暂存必要的临时配置（例如内存或临时态）。
- 权限与鉴权
  - 登录需提供必要的鉴权信息（例如 Token/密钥/坐席号）；权限校验失败需明确提示并记录到事件日志面板。
  - 不落地账号体系改造；仅调用现有 SDK 的鉴权能力。
- 连通性与稳定性
  - 提供基础连通性检查：在登录前/后可进行一次 SDK 可达性探测（例如调用健康检查或轻量接口，若 SDK 提供）。
  - 对网络异常、超时、断线重连有明确的错误提示与有限重试策略（例如最多 3 次，以防止误触发风暴）。
- 兼容性
  - 浏览器：Chrome 最新稳定版为主；其他浏览器不作为本次验收范围。
  - 屏幕分辨率适配到常见桌面端（≥1366×768）；移动端不在本次范围。
- 性能与日志
  - 事件日志面板需滚动分页或限制最大条数，以避免长时间运行导致页面性能问题。
  - 错误与关键步骤写入控制台日志（仅开发环境），便于调试与验收。

## 配置项与依赖
- 必要配置（示例，具体以 SDK 文档为准）：
  - sdkBaseUrl（AgentSDK 基址）
  - tenantId / bizLine / agentId（租户/业务线/坐席标识）
  - authToken（鉴权令牌）
  - displayNumber / dialPrefix（外呼相关可选参数）
- 运行依赖：
  - 可用的 CTICloud/AgentSDK 环境与测试账号、可达的网络与 HTTPS 证书配置。
  - 若需软电话拨测，需具备可用的 SIP 服务器与账号，并允许浏览器端 WebRTC/SIP 连接（按 SDK 能力）。

## 关键流程（最小闭环）
- 登录
  - 输入配置与凭据 → 调用 SDK 登录 → 返回码为 0 切换为已登录态 → 事件订阅开启。
- 预览外呼
  - 输入被叫号码 → 调用 previewObCall → 展示进度事件 → 收到 result 事件（成功/失败）→ 在事件日志面板记录摘要与载荷片段。
- 软电话
  - 点击 sipLink → 连接成功后状态指示变为已连接 → 可进行接听/挂断模拟或事件观察 → 点击 sipUnlink 断开。
- 登出
  - 调用 SDK 登出 → 清理订阅与会话 → UI 回到未登录态。

## 异常与错误处理分支
- 登录失败
  - Promise reject 或返回码非 0；显示错误原因（若可用），记录事件日志，允许重试。
- 事件订阅失败/无事件
  - 订阅接口异常或断线；UI 显示警示，支持手动重试与有限自动重连。
- 预览外呼失败
  - 参数校验失败、网络超时、被叫不可达；记录错误事件与返回码/原因，提示用户。
- 软电话异常
  - sipLink 失败（鉴权、网络、SIP 服务器异常）、通话过程中断线；展示状态变化与错误提示，允许 sipUnlink 清理并重试。
- 通用错误策略
  - 对于 Promise reject 与 code!=0 的情况，统一在界面与事件面板进行展示；关键路径提供重试按钮；记录发生时间与操作上下文。

## 验收标准
- 成功登录/登出
  - 发起登录返回码 code=0，UI 状态与事件面板均显示登录成功；登出后状态清理完成。
- 事件展示
  - 事件日志面板能实时展示关键事件与载荷片段（含时间与事件名）；支持基本过滤或检索。
- 拨测成功（预览外呼）
  - 能成功调用 previewObCall 并在合理时间内收到 result 事件；成功时返回码为 0，失败时给出明确错误信息与记录。
- 软电话能力
  - 能执行 sipLink 并显示已连接状态；执行 sipUnlink 后状态更新为未连接；在连接态观察到相关事件（例如来电/挂断事件，依据环境与 SDK 能力）。
- 错误处理覆盖
  - Promise reject 与 code!=0 的分支均有可视化提示与事件记录；断线/重连场景有清晰提示与有限重试。
- 非功能达标
  - 通过 HTTPS 访问；基础连通性检查通过；权限校验失败有明确提示；日志面板对长时间运行有性能保护。

## 验收方法与测试用例（示例）
- 用例 1：登录成功
  - 输入有效凭据 → 点击登录 → 期望：code=0，UI 显示已登录，事件面板出现登录成功事件。
- 用例 2：登录失败（鉴权错误）
  - 输入错误 Token → 点击登录 → 期望：提示鉴权失败，事件面板记录错误事件与返回码。
- 用例 3：事件订阅断线重试
  - 人为断网或切换网络 → 期望：显示断线提示、有限次自动重试；恢复网络后显示重连成功事件。
- 用例 4：预览外呼成功
  - 输入可达号码 → 发起外呼 → 期望：显示进度事件，收到成功 result（code=0）。
- 用例 5：预览外呼失败（号码非法/不可达）
  - 输入非法号码 → 发起外呼 → 期望：收到失败 result，错误原因展示与事件记录。
- 用例 6：软电话连接/断开
  - 点击 sipLink → 显示已连接 → 随后点击 sipUnlink → 显示未连接；事件面板记录连接与断开事件。

## 里程碑与交付物
- 本次交付：更新并完善《PRD.md》，包含背景、用户故事、非功能需求（HTTPS/权限/连通性）、验收标准（登录/事件展示/拨测/sipLink/sipUnlink/错误处理分支）、范围与不包含项。
- 后续（如需）：可根据验收反馈补充具体事件名列表与字段描述（以 SDK 文档为准），不在本次交付范围内。
